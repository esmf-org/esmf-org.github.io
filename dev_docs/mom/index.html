<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>MOM NUOPC Cap: MOM NUOPC Cap</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">MOM NUOPC Cap
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MOM NUOPC Cap </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Overview">Overview</a><ul><li class="level2"><a href="#CapSubroutines">Cap Subroutines</a></li>
</ul>
</li>
<li class="level1"><a href="#UnderlyingModelInterfaces">Underlying Model Interfaces</a><ul><li class="level2"><a href="#DomainCreation">Domain Creation</a></li>
<li class="level2"><a href="#Initialization">Initialization</a></li>
<li class="level2"><a href="#Run">Run</a><ul><li class="level3"><a href="#VectorRotations">Vector Rotations</a></li>
</ul>
</li>
<li class="level2"><a href="#Finalization">Finalization</a></li>
</ul>
</li>
<li class="level1"><a href="#ModelFields">Model Fields</a><ul><li class="level2"><a href="#ImportFields">Import Fields</a></li>
<li class="level2"><a href="#ExportField">Export Fields</a></li>
<li class="level2"><a href="#MemoryManagement">Memory Management</a></li>
<li class="level2"><a href="#IO">I/O</a></li>
</ul>
</li>
<li class="level1"><a href="#BuildingAndInstalling">Building and Installing</a><ul><li class="level2"><a href="#Dependencies">Dependencies</a></li>
</ul>
</li>
<li class="level1"><a href="#RuntimeConfiguration">Runtime Configuration</a></li>
<li class="level1"><a href="#Repository"></a></li>
<li class="level1"><a href="#References"></a></li>
</ul>
</div>
<div class="textblock"><dl class="section author"><dt>Author</dt><dd>Fei Liu (<a href="#" onclick="location.href='mai'+'lto:'+'fei'+'.l'+'iu@'+'gm'+'ail'+'.c'+'om'; return false;">fei.l<span style="display: none;">.nosp@m.</span>iu@g<span style="display: none;">.nosp@m.</span>mail.<span style="display: none;">.nosp@m.</span>com</a>) </dd></dl>
<dl class="section date"><dt>Date</dt><dd>1/12/17 Original documentation</dd></dl>
<h1><a class="anchor" id="Overview"></a>
Overview</h1>
<p><b>This MOM cap has been tested with MOM5 and MOM6.</b></p>
<p>This document describes the MOM "cap", which is a small software layer that is required when the <a href="http://mom-ocean.org/web">MOM ocean model</a> is used in <a href="http://www.earthsystemcog.org/projects/nuopc">National Unified Operation Prediction Capability</a> (NUOPC) coupled systems. The NUOPC Layer is a software layer built on top of the <a href="https://www.earthsystemcog.org/projects/esmf">Earth System Modeling Framework</a> (ESMF). ESMF is a high-performance modeling framework that provides data structures, interfaces, and operations suited for building coupled models from a set of components. NUOPC refines the capabilities of ESMF by providing a more precise definition of what it means for a model to be a component and how components should interact and share data in a coupled system. The NUOPC Layer software is designed to work with typical high-performance models in the Earth sciences domain, most of which are written in Fortran and are based on a distributed memory model of parallelism (MPI). A NUOPC "cap" is a Fortran module that serves as the interface to a model when it's used in a NUOPC-based coupled system. The term "cap" is used because it is a small software layer that sits on top of model code, making calls into it and exposing model data structures in a standard way. For more information about creating NUOPC caps in general, please see the <a href="http://www.earthsystemmodeling.org/esmf_releases/non_public/ESMF_7_0_0/NUOPC_howtodoc/">Building a NUOPC Model</a> how-to document.</p>
<p>The MOM cap package includes the cap itself (<a class="el" href="mom__cap_8F90.html">mom_cap.F90</a>, a Fortran module), a set of time utilities (<a class="el" href="time__utils_8F90.html">time_utils.F90</a>) for converting between ESMF and FMS time types, and two makefiles. Also included are self-describing dependency makefile fragments (mom5.mk and mom5.mk.template), although these can be generated by the makefiles for specific installations of the MOM cap.</p>
<h2><a class="anchor" id="CapSubroutines"></a>
Cap Subroutines</h2>
<p>The MOM cap Fortran module contains a set of subroutines that are required by NUOPC. These subroutines are called by the NUOPC infrastructure according to a predefined calling sequence. Some subroutines are called during initialization of the coupled system, some during the run of the coupled system, and some during finalization of the coupled system. The initialization sequence is the most complex and is governed by the NUOPC technical rules. Details about the initialization sequence can be found in the <a href="http://www.earthsystemmodeling.org/esmf_releases/non_public/ESMF_7_0_0/NUOPC_refdoc/node3.html#SECTION00034000000000000000">NUOPC Reference Manual</a>.</p>
<p>A particularly important part of the NUOPC intialization sequence is to establish field connections between models. Simply put, a field connection is established when a field output by one model can be consumed by another. As an example, the MOM model is able to accept a precipitation rate when coupled to an atmosphere model. In this case a field connection will be established between the precipitation rate exported from the atmosphere and the precipitation rate imported into the MOM model. Because models may uses different variable names for physical quantities, NUOPC relies on a set of standard names and a built-in, extensible standard name dictionary to match fields between models. More information about the use of standard names can be found in the <a href="http://www.earthsystemmodeling.org/esmf_releases/non_public/ESMF_7_0_0/NUOPC_refdoc/node3.html#SECTION00032000000000000000">NUOPC Reference Manual</a>.</p>
<p>Two key initialization phases that appear in every NUOPC cap, including this MOM cap are the field "advertise" and field "realize" phases. <em>Advertise</em> is a special NUOPC term that refers to a model participating in a coupled system providing a list of standard names of required import fields and available export fields. In other words, each model will advertise to the other models which physical fields it needs and which fields it can provide when coupled. NUOPC compares all of the advertised standard names and creates a set of unidirectional links, each from one export field in a model to one import field in another model. When these connections have been established, all models in the coupled system need to provide a description of their geographic grid (e.g., lat-lon, tri-polar, cubed sphere, etc.) and allocate their connected fields on that grid. In NUOPC terms, this is refered to as <em>realizing</em> a set of fields. NUOPC relies on ESMF data types for this, such as the <a href="http://www.earthsystemmodeling.org/esmf_releases/public/last/ESMF_refdoc/node5.html#SECTION05080000000000000000">ESMF_Grid</a> type, which describes logically rectangular grids and the <a href="http://www.earthsystemmodeling.org/esmf_releases/public/last/ESMF_refdoc/node5.html#SECTION05030000000000000000">ESMF_Field</a> type, which wraps a models data arrays and provides basic metadata. Because ESMF supports interpolation between different grids (sometimes called "regridding" or "grid remapping"), it is not necessary that models share a grid. As you will see below the <em>advertise</em> and <em>realize</em> phases each have a subroutine in the HYCOM cap.</p>
<p>The following table summarizes the NUOPC-required subroutines that appear in the MOM cap. The "Phase" column says whether the subroutine is called during the initialization, run, or finalize part of the coupled system run.</p>
<table class="doxtable">
<tr>
<th>Phase </th><th>MOM Cap Subroutine </th><th>Description  </th></tr>
<tr>
<td>Init </td><td><a class="el" href="classmom__cap__mod.html#a9b1bd237d48b444c8c3410371aedc854">InitializeP0</a> </td><td>Sets the Initialize Phase Definition (IPD) version to use </td></tr>
<tr>
<td>Init </td><td><a class="el" href="classmom__cap__mod.html#a2ec10447622ec1cd4cb568c194b8de61">InitializeAdvertise</a> </td><td>Advertises standard names of import and export fields </td></tr>
<tr>
<td>Init </td><td><a class="el" href="classmom__cap__mod.html#a11baa4d10abcce4225eb074a2c23e398">InitializeRealize</a> </td><td>Creates an ESMF_Grid for the MOM grid as well as ESMF_Fields for import and export fields </td></tr>
<tr>
<td>Init </td><td><a class="el" href="classmom__cap__mod.html#af1c75a75b466ee346fd3b049a6daeefd">SetClock</a> </td><td>Ensures stability timestep constraint is met </td></tr>
<tr>
<td>Run </td><td><a class="el" href="classmom__cap__mod.html#aecd83368409a9c059ca3313e25391a0b">ModelAdvance</a> </td><td>Advances the model by a timestep </td></tr>
<tr>
<td>Final </td><td><a class="el" href="classmom__cap__mod.html#a9b7799c15a6eeadc1d286ce4d37163e6">Finalize</a> </td><td>Cleans up </td></tr>
</table>
<h1><a class="anchor" id="UnderlyingModelInterfaces"></a>
Underlying Model Interfaces</h1>
<h2><a class="anchor" id="DomainCreation"></a>
Domain Creation</h2>
<p>The MOM tripolar grid is represented as a 2D <code>ESMF_Grid</code> and coupling fields are placed on this grid. Calls related to creating the grid are located in the <a class="el" href="classmom__cap__mod.html#a11baa4d10abcce4225eb074a2c23e398">InitializeRealize</a> subroutine, which is called by the NUOPC infrastructure during the intialization sequence.</p>
<p>The cap determines parameters for setting up the grid by calling subroutines in the <code>mpp_domains_mod</code> module. The global domain size is determined by calling <code>mpp_get_global_domain()</code>. A check is in place to ensure that there is only a single tile in the domain (the cap is currently limited to one tile; multi-tile mosaics are not supported). The decomposition across processors is determined via calls to <code>mpp_get_compute_domains()</code> (to retrieve decomposition block indices) and <code>mpp_get_pelist()</code> (to determine how blocks are assigned to processors).</p>
<p>The grid is created in several steps:</p>
<ul>
<li>an <code>ESMF_DELayout</code> is created based on the pelist from MOM</li>
<li>an <code>ESMF_DistGrid</code> is created over the global index space. Connections are set up so that the index space is periodic in the first dimension and has a fold at the top for the bipole. The decompostion blocks are also passed in along with the <code>ESMF_DELayout</code> mentioned above.</li>
<li>an <code>ESMF_Grid</code> is then created by passing in the above <code>ESMF_DistGrid</code>.</li>
</ul>
<p>Masks, areas, center (tlat, tlon), and corner (ulat, ulon) coordinates are then added to the <code>ESMF_Grid</code> by retrieving those fields from MOM with calls to <code>ocean_model_data_get()</code>.</p>
<h2><a class="anchor" id="Initialization"></a>
Initialization</h2>
<p>During the <a class="el" href="classmom__cap__mod.html#a2ec10447622ec1cd4cb568c194b8de61">InitializeAdvertise</a> phase, calls are made to MOM's native initialization subroutines, including <code>fms_init()</code>, <code>constants_init()</code>, <code>field_manager_init()</code>, <code>diag_manager_init()</code>, and <code>set_calendar_type()</code>. The MPI communicator is pulled in through the ESMF VM object for the MOM component. The dt and start time are set from parameters from the incoming ESMF clock with calls to <code>set_time()</code> and <code>set_date().</code></p>
<h2><a class="anchor" id="Run"></a>
Run</h2>
<p>The <a class="el" href="classmom__cap__mod.html#aecd83368409a9c059ca3313e25391a0b">ModelAdvance</a> subroutine is called by the NUOPC infrastructure when it's time for MOM to advance in time. During this subroutine, there is a call into the MOM update routine: </p>
<pre class="fragment"> call update_ocean_model(Ice_ocean_boundary, Ocean_state, Ocean_sfc, Time, Time_step_coupled)
</pre><p>Prior to this call, the cap performs a few steps:</p>
<ul>
<li>the <code>Time</code> and <code>Time_step_coupled</code> parameters, which are based on FMS types, are derived from the incoming ESMF clock</li>
<li>there are calls to two stubs: <code>ice_ocn_bnd_from_data()</code> and <code>external_coupler_sbc_before()</code> - these are currently inactive, but may be modified to read in import data from file or from an external coupler</li>
<li>diagnostics are optionally written to files <code>field_ocn_import_*</code>, one for each import field</li>
<li>import fields are prepared:<ul>
<li>the sign is reversed on <code>mean_evap_rate</code> and <code>mean_sensi_heat_flux</code></li>
<li>momentum flux vectors are rotated to internal grid</li>
</ul>
</li>
<li>optionally, a call is made to <code>ocean_model_restart()</code> at the interval <code>restart_interval</code></li>
</ul>
<p>After the call to <code>update_ocean_model()</code>, the cap performs these steps:</p>
<ul>
<li>the <code>ocean_mask</code> export is set to match that of the internal MOM mask</li>
<li>the <code>freezing_melting_potential</code> export is converted from J m-2 to W m-2 by dividing by the coupling interval</li>
<li>vector rotations are applied to the <code>ocean_current_zonal</code> and <code>ocean_current_merid</code> exports, back to lat-lon grid</li>
<li>diagnostics are optionally written to files <code>field_ocn_export_*</code>, one for each export field</li>
<li>a call is made to <code>external_coupler_sbc_after()</code> to update exports from an external coupler (currently an inactive stub)</li>
<li>calls are made to <code>dumpMomInternal()</code> to write files <code>field_ocn_internal_*</code> for all internal fields (both import and export)</li>
</ul>
<h3><a class="anchor" id="VectorRotations"></a>
Vector Rotations</h3>
<p>Vector rotations are applied to incoming momentum fluxes (from regular lat-lon to tripolar grid) and outgoing ocean currents (from tripolar to regular lat-lon). The rotation angles are provided from the native MOM grid by a call to <code>get_ocean_grid(Ocean_grid)</code>. The cosine and sine of the rotation angle are: </p>
<pre class="fragment">Ocean_grid%cos_rot(i,j)
Ocean_grid%sin_rot(i,j)
</pre><p>The rotation of momentum flux from regular lat-lon to tripolar is: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \begin{bmatrix} \tau_x' \ \tau_y' \end{bmatrix} = \begin{bmatrix} cos \theta &amp; sin \theta \ -sin \theta &amp; cos \theta \end{bmatrix} * \begin{bmatrix} \tau_x \ \tau_y \end{bmatrix} \]" src="form_0.png"/>
</p>
<p>The rotation of ocean current from tripolar to regular lat-lon is: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \begin{bmatrix} u' \ v' \end{bmatrix} = \begin{bmatrix} cos \theta &amp; -sin \theta \ sin \theta &amp; cos \theta \end{bmatrix} * \begin{bmatrix} u \ v \end{bmatrix} \]" src="form_1.png"/>
</p>
 <h2><a class="anchor" id="Finalization"></a>
Finalization</h2>
<p>NUOPC infrastructure calls <a class="el" href="classmom__cap__mod.html#a9b7799c15a6eeadc1d286ce4d37163e6">ocean_model_finalize</a> at the end of the run. This subroutine is a hook to call into MOM's native shutdown procedures: </p>
<pre class="fragment">call ocean_model_end (Ocean_sfc, Ocean_State, Time)
call diag_manager_end(Time )
call field_manager_end
call fms_io_exit
call fms_end
</pre><h1><a class="anchor" id="ModelFields"></a>
Model Fields</h1>
<p>The following tables list the import and export fields currently set up in the MOM cap.</p>
<h2><a class="anchor" id="ImportFields"></a>
Import Fields</h2>
<table class="doxtable">
<tr>
<th>Standard Name </th><th>Units </th><th>Model Variable </th><th>Description </th><th>Notes  </th></tr>
<tr>
<td>inst_pres_height_surface </td><td>Pa </td><td>p </td><td>pressure of overlying sea ice and atmosphere </td><td></td></tr>
<tr>
<td>mass_of_overlying_sea_ice </td><td>kg </td><td>mi </td><td>mass of overlying sea ice </td><td></td></tr>
<tr>
<td>mean_calving_heat_flx </td><td>W m-2 </td><td>calving_hflx </td><td>heat flux, relative to 0C, of frozen land water into ocean </td><td></td></tr>
<tr>
<td>mean_calving_rate </td><td>kg m-2 s-1 </td><td>calving </td><td>mass flux of frozen runoff </td><td></td></tr>
<tr>
<td>mean_evap_rate </td><td>kg m-2 s-1 </td><td>q_flux </td><td>specific humidity flux </td><td>sign reversed (- evap) </td></tr>
<tr>
<td>mean_fprec_rate </td><td>kg m-2 s-1 </td><td>fprec </td><td>mass flux of frozen precip </td><td></td></tr>
<tr>
<td>mean_merid_moment_flx </td><td>Pa </td><td>v_flux </td><td>j-directed wind stress into ocean </td><td><a class="el" href="index.html#VectorRotations">vector rotation</a> applied - lat-lon to tripolar </td></tr>
<tr>
<td>mean_net_lw_flx </td><td>W m-2 </td><td>lw_flux </td><td>long wave radiation </td><td></td></tr>
<tr>
<td>mean_net_sw_ir_dif_flx </td><td>W m-2 </td><td>sw_flux_nir_dif </td><td>diffuse near IR shortwave radiation </td><td></td></tr>
<tr>
<td>mean_net_sw_ir_dir_flx </td><td>W m-2 </td><td>sw_flux_nir_dir </td><td>direct near IR shortwave radiation </td><td></td></tr>
<tr>
<td>mean_net_sw_vis_dif_flx </td><td>W m-2 </td><td>sw_flux_vis_dif </td><td>diffuse visible shortware radiation </td><td></td></tr>
<tr>
<td>mean_net_sw_vis_dir_flx </td><td>W m-2 </td><td>sw_flux_vis_dir </td><td>direct visible shortware radiation </td><td></td></tr>
<tr>
<td>mean_prec_rate </td><td>kg m-2 s-1 </td><td>lprec </td><td>mass flux of liquid precip </td><td></td></tr>
<tr>
<td>mean_runoff_heat_flx </td><td>W m-2 </td><td>runoff_hflx </td><td>heat flux, relative to 0C, of liquid land water into ocean </td><td></td></tr>
<tr>
<td>mean_runoff_rate </td><td>kg m-2 s-1 </td><td>runoff </td><td>mass flux of liquid runoff </td><td></td></tr>
<tr>
<td>mean_salt_rate </td><td>kg m-2 s-1 </td><td>salt_flux </td><td>salt flux </td><td></td></tr>
<tr>
<td>mean_sensi_heat_flx </td><td>W m-2 </td><td>t_flux </td><td>sensible heat flux into ocean </td><td>sign reversed (- sensi) </td></tr>
<tr>
<td>mean_zonal_moment_flx </td><td>Pa </td><td>u_flux </td><td>j-directed wind stress into ocean </td><td><a class="el" href="index.html#VectorRotations">vector rotation</a> applied - lat-lon to tripolar </td></tr>
</table>
<h2><a class="anchor" id="ExportField"></a>
Export Fields</h2>
<p>Export fields are populated from the <code>ocean_sfc</code> parameter (type <code>ocean_public_type</code>) after the call to <code>update_ocean_model()</code>.</p>
<table class="doxtable">
<tr>
<th>Standard Name </th><th>Units </th><th>Model Variable </th><th>Description </th><th>Notes  </th></tr>
<tr>
<td>freezing_melting_potential </td><td>W m-2 </td><td>frazil </td><td>accumulated heating from frazil formation </td><td>cap converts model units (J m-2) to (W m-2) for export </td></tr>
<tr>
<td>ocean_mask </td><td></td><td></td><td>ocean mask </td><td></td></tr>
<tr>
<td>ocn_current_merid </td><td>m s-1 </td><td>v_surf </td><td>j-directed surface velocity on u-cell </td><td><a class="el" href="index.html#VectorRotations">vector rotation</a> applied - tripolar to lat-lon </td></tr>
<tr>
<td>ocn_current_zonal </td><td>m s-1 </td><td>u_surf </td><td>i-directed surface velocity on u-cell </td><td><a class="el" href="index.html#VectorRotations">vector rotation</a> applied - tripolar to lat-lon </td></tr>
<tr>
<td>s_surf </td><td>psu </td><td>s_surf </td><td>sea surface salinity on t-cell </td><td></td></tr>
<tr>
<td>sea_lev </td><td>m </td><td>sea_lev </td><td>sea level </td><td>model computation is eta_t + patm/(rho0*grav) - eta_geoid - eta_tide </td></tr>
<tr>
<td>sea_surface_temperature </td><td>K </td><td>t_surf </td><td>sea surface temperature on t-cell </td><td></td></tr>
</table>
<h2><a class="anchor" id="MemoryManagement"></a>
Memory Management</h2>
<p>The MOM cap has an internal state type with pointers to three types defined by MOM. There is also a small wrapper derived type required to associate an internal state instance with the ESMF/NUOPC component: </p>
<pre class="fragment">type ocean_internalstate_type
   type(ocean_public_type),       pointer :: ocean_public_type_ptr
   type(ocean_state_type),        pointer :: ocean_state_type_ptr
   type(ice_ocean_boundary_type), pointer :: ice_ocean_boundary_type_ptr
end type

type ocean_internalstate_wrapper
   type(ocean_internalstate_type), pointer :: ptr
end type
</pre><p>The member of type <code>ocean_public_type</code> stores ocean surface fields used during the coupling. The member of type <code>ocean_state_type</code> is required by the ocean driver, although its internals are private (not to be used by the coupling directly). This type is passed to the ocean init and update routines so that it can maintain state there if desired. The member of type <code>ice_ocean_boundary_type</code> is populated by this cap with incoming coupling fields from other components. These three derived types are allocated during the <a class="el" href="classmom__cap__mod.html#a2ec10447622ec1cd4cb568c194b8de61">InitializeAdvertise</a> phase. Also during that phase, the <code>ice_ocean_boundary</code> type members are all allocated using bounds retrieved from <code>mpp_get_compute_domain()</code>.</p>
<p>During the <a class="el" href="classmom__cap__mod.html#a11baa4d10abcce4225eb074a2c23e398">InitializeRealize</a> phase, <code>ESMF_Field</code>s are created for each of the coupling fields in the <code>ice_ocean_boundary</code> and <code>ocean_public_type</code> members of the internal state. These fields directly reference into the members of the <code>ice_ocean_boundary</code> and <code>ocean_public_type</code> so that memory-to-memory copies are not required to move data from the cap's import and export states to the memory areas used internally by MOM.</p>
<h2><a class="anchor" id="IO"></a>
I/O</h2>
<p>The cap can optionally output coupling fields for diagnostic purposes if the ESMF attribute "DumpFields" has been set to "true". In this case the cap will write out NetCDF files with names "field_ocn_import_&lt;fieldname&gt;.nc" and "field_ocn_export_&lt;fieldname&gt;.nc". Additionally, calls will be made to the cap subroutine <a class="el" href="classmom__cap__mod.html#aafac88f280349b42aa5ee72ca90fed0d">dumpMomInternal</a> to write out model internal fields to files named "field_ocn_internal_&lt;fieldname&gt;.nc". In all cases these NetCDF files will contain a time series of field data.</p>
<h1><a class="anchor" id="BuildingAndInstalling"></a>
Building and Installing</h1>
<p>There are two makefiles included with the MOM cap, makefile and makefile.nuopc. The makefile.nuopc file is intended to be used within another build system, such as the NEMSAppBuilder. The regular makefile can be used generally for building and installing the cap. Two variables must be customized at the top:</p>
<ul>
<li><code>INSTALLDIR</code> - where to copy the cap library and dependent libraries</li>
<li><code>NEMSMOMDIR</code> - location of the MOM library and FMS library</li>
</ul>
<p>To install run: $ make install</p>
<p>A makefile fragment, mom5.mk, will also be copied into the directory. The fragment defines several variables that can be used by another build system to include the MOM cap and its dependencies.</p>
<h2><a class="anchor" id="Dependencies"></a>
Dependencies</h2>
<p>The MOM cap is dependent on the MOM library itself (lib_ocean.a) and the FMS library (lib_FMS.a).</p>
<h1><a class="anchor" id="RuntimeConfiguration"></a>
Runtime Configuration</h1>
<p>At runtime, the MOM cap can be configured with several options provided as ESMF attributes. Attributes can be set in the cap by the NUOPC Driver above this cap, or in some systems (e.g., NEMS) attributes are set by reading in from a configuration file. The available attributes are:</p>
<ul>
<li><code>DumpFields</code> - when set to "true", write out diagnostic NetCDF files for import/export/internal fields</li>
<li><code>ProfileMemory</code> - when set to "true", write out memory usage information to the ESMF log files; this information is written when entering and leaving the <a class="el" href="classmom__cap__mod.html#aecd83368409a9c059ca3313e25391a0b">ModelAdvance</a> subroutine and before and after the call to <code>update_ocean_model()</code>.</li>
<li><code>OceanSolo</code> - when set to "true", this option indicates that MOM is being run uncoupled; in this case the vector rotations and other data manipulations on import fields are skipped</li>
<li><code>restart_interval</code> - integer number of seconds indicating the interval at which to call <code>ocean_model_restart()</code>; no restarts written if set to 0</li>
</ul>
<h1><a class="anchor" id="Repository"></a>
Repository</h1>
<p>The MOM NUOPC cap is maintained in a GitHub repository: <a href="https://github.com/feiliuesmf/nems_mom_cap">https://github.com/feiliuesmf/nems_mom_cap</a></p>
<h1><a class="anchor" id="References"></a>
References</h1>
<ul>
<li><a href="http://mom-ocean.org/web">MOM Home Page</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
